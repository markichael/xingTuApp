# 比例裁剪实现与截图说明

## 1. 通俗说明
**为什么要单独做？**
在安卓手机上，“裁剪图片”听起来简单，但其实坑很多：不同品牌的手机系统自带裁剪界面长得不一样，有的还会因为权限问题导致应用闪退。如果我们自己从头写一个支持旋转、缩放、各种比例裁剪的功能，工作量巨大且容易出 Bug。

**我们做了什么？**
我们引入了一个久经考验的开源库 —— **uCrop**：

- **统一体验**：不管在什么手机上，裁剪界面都是统一的黑色专业风格。
- **手势操作**：支持双指缩放、旋转，操作非常丝滑。
- **预设比例**：贴心地准备好了 1:1（头像）、16:9（封面）、3:4 等常用比例，一点就变。
- **自动衔接**：剪完图后，自动帮你跳转到“滤镜”页面，方便你接着调色，一气呵成。

## 2. 功能目标
- **稳定性**：解决 Android 碎片化导致的裁剪崩溃问题（尤其是权限和文件路径）。
- **易用性**：提供直观的比例选择（原始、1:1、3:4、3:2、16:9）和自由裁剪。
- **流畅度**：利用 uCrop 的原生 C++ 库进行图片处理，裁剪生成速度快，不卡顿。
- **工作流**：打造“选图 -> 裁剪 -> 调色 -> 保存”的闭环体验。

## 3. 核心技术点
- **uCrop 集成**：作为核心引擎，接管裁剪与旋转逻辑。
- **FileProvider 适配**：为了兼容 Android 7.0+ 的严格权限策略，我们使用 `FileProvider` 生成临时的安全 URI (`content://...`) 传递给 uCrop，避免 `FileUriExposedException` 崩溃。
- **单页/内嵌双模式**：既支持首页直接进入裁剪（`CropRotateScreen`），也支持在编辑器中途调用（`EditorShell`）。
- **URI 回传机制**：通过 `ActivityResultLauncher` 接收裁剪后的新图片路径，并无缝替换当前编辑对象。

## 4. 实施细节与关键代码

### 4.1 裁剪参数配置 (`ui/CropRotateScreen.kt`)
为了让裁剪界面和我们的 App 风格统一（黑色酷炫风），并提供常用比例，我们做了如下配置：

```kotlin
val options = UCrop.Options().apply {
    // 1. 设置界面颜色（黑色背景，高亮色主题）
    setToolbarColor(0xFF000000.toInt())
    setStatusBarColor(0xFF000000.toInt())
    setToolbarWidgetColor(0xFFCCFF00.toInt()) // 醒目的黄绿色文字
    setActiveControlsWidgetColor(0xFFCCFF00.toInt()) // 选中项颜色
    
    // 2. 开启手势
    setAllowedGestures(UCropActivity.SCALE, UCropActivity.ROTATE, UCropActivity.SCALE)
    
    // 3. 预设比例列表
    setAspectRatioOptions(
        0,
        AspectRatio("原始", 0f, 0f),
        AspectRatio("1:1", 1f, 1f),
        AspectRatio("3:4", 3f, 4f),
        AspectRatio("3:2", 3f, 2f),
        AspectRatio("16:9", 16f, 9f)
    )
}

// 启动 uCrop（注意使用 FileProvider 生成的目标路径）
val intent = UCrop.of(srcUri, dstUri)
    .withOptions(options)
    .getIntent(context)
```

### 4.2 结果处理与自动跳转 (`ui/EditorShell.kt`)
当用户在编辑器里点“裁剪”，完成后我们会自动帮他切到“滤镜”模式：

```kotlin
if (result.resultCode == RESULT_OK && data != null) {
    val outUri = UCrop.getOutput(data)
    if (outUri != null) {
        // 1. 重新加载裁剪后的图片
        loadImage(outUri) 
        // 2. 自动切换到滤镜 Tab，提升心流体验
        category = EditorCategory.FILTER 
        Toast.makeText(context, "已裁剪", Toast.LENGTH_SHORT).show()
    }
}
```

## 5. 截图验证要点
请在真机或模拟器按以下顺序采集 3 张截图，用于验收功能：

1.  **裁剪界面 (`01_比例裁剪界面.png`)**
    -   **画面内容**：显示图片被裁剪框包围，底部有一排比例按钮（1:1, 3:4 等），右上角有黄绿色的“√”或完成按钮。
    -   **验证点**：UI 配色是否为黑色背景+黄绿色高亮，比例选项是否齐全。

2.  **裁剪后进入滤镜 (`02_裁剪后进入滤镜.png`)**
    -   **画面内容**：裁剪完成后回到编辑器，底部的 Tab 应该自动选中在“滤镜”上，且主图已经是裁剪后的形状。
    -   **验证点**：流程跳转是否顺畅，图片是否被拉伸（不应变形）。

3.  **导出完成 (`03_导出完成.png`)**
    -   **画面内容**：点击右上角“导出”后的结果页，或者系统相册里的最终效果图。
    -   **验证点**：保存的图片是否清晰，是否保留了刚才的裁剪和滤镜效果。

## 6. 操作说明
1.  **入口一（首页直达）**：在 App 首页点击“裁剪旋转”大卡片 -> 选图 -> 直接进入裁剪界面。
2.  **入口二（编辑中途）**：在“全能编辑器”中 -> 点击底部“调整”分类 -> 系统会自动拉起裁剪界面；或者点击工具栏里的“裁剪旋转”按钮。
3.  **完成操作**：选好比例，旋转满意后 -> 点击右上角“√” -> 自动回到编辑器 -> 继续加滤镜或保存。
