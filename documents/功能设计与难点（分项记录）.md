# 功能设计与难点（分项记录）

> 为每项功能分别记录：整体设计、开发遇到的困难、解决思路，并附关键代码路径。

## 简明总览（通俗版）

- 流程：选照片 → 简单编辑/AI处理 → 保存到相册 → 看结果/继续修图。
- 预览用小图保证流畅，导出用原图保证清晰。
- 常见机型差异与内存问题都有兜底方案，尽量不崩不卡。

## 裁剪旋转（uCrop 单页直达）
- 通俗说明
  - 点击“裁剪旋转”直接进裁剪页，选好比例/旋转后点完成，回到编辑继续调。
  - 为避免权限/崩溃问题，文件用 `FileProvider`，并给足读写授权。
- 整体设计
  - 单页组件 `CropRotateScreen`，进入即拉起 uCrop，配置统一主题与比例预设（原始比例、1:1、3:4、3:2、16:9），裁剪完成回传结果，再继续编辑或导出。
- 开发遇到的困难
  - 编辑器内嵌裁剪路径深，返回复杂。
  - 部分机型权限与崩溃问题（详细）：
    - **权限碎片化**：Android 13+ 需请求 `READ_MEDIA_IMAGES`，而旧版本需 `READ_EXTERNAL_STORAGE`，未正确适配会导致相册空白或崩溃。
    - **FileUriExposedException**：Android 7.0+ 禁止在 Intent 中直接传递 `file://` URI，否则抛出异常导致 Crash。
    - **分区存储（Scoped Storage）限制**：Android 10+ 限制直接访问公共目录文件路径。若 uCrop 输出路径设置为公共目录且无权限，会导致裁剪保存失败。
- 解决思路
  - 改为单页直达；目标文件使用 `FileProvider + externalCacheDir` 并加 READ/WRITE flags；完成后回传并切换到滤镜页。
- 关键代码路径
  - `app/src/main/java/com/example/xingtuclone/ui/CropRotateScreen.kt:61-83`（uCrop 主题与比例预设）
  - `app/src/main/java/com/example/xingtuclone/ui/CropRotateScreen.kt:84-89`（启动与回调）
  - `app/src/main/java/com/example/xingtuclone/ui/HomeScreen.kt:153-162`（路由到裁剪并回传）
  - `app/src/main/java/com/example/xingtuclone/ui/EditorShell.kt:193-195`（裁剪后切换到滤镜）
  - `app/src/main/java/com/example/xingtuclone/MainActivity.kt:33-49`（`FileProvider` 创建临时文件）

## 魔法消除（ONNX Inpaint）
- 通俗说明
  - 用画笔涂要删的地方，AI自动补背景；能切换“显示蒙版”看看涂抹区域。
  - 为了不卡，预览用小图，AI运算放后台，保存统一走系统相册接口。
- 整体设计
  - 画笔/羽化控制与蒙版显示；推理引擎 `OnnxLamaInpainter` 执行 inpaint，预览实时更新，保存后返回结果页。
- 开发遇到的困难
  - 模型加载与推理耗时；蒙版绘制的交互与性能；不同设备 ABI 兼容。
- 解决思路
  - 预览降采样，蒙版绘制使用 `Canvas+Paint`；推理在 IO 线程；保存走统一 `MediaStore`；逐步按 ABI 控制模型体积。
- 关键代码路径
  - `app/src/main/java/com/example/xingtuclone/ui/MagicEraseScreen.kt:56-61`（推理更新预览）
  - `app/src/main/java/com/example/xingtuclone/ui/MagicEraseScreen.kt:126-141`（保存与回传）
  - `app/src/main/java/com/example/xingtuclone/inpaint/OnnxLamaInpainter.kt`（推理实现）

## 人像美颜（RenderScript 流水线）
- 通俗说明
  - 提供磨皮、美白、红润、锐化，滑条一调就生效；预览流畅、导出清晰。
  - 新系统对 RenderScript 不友好，已开兼容模式并逐步替换更稳的实现。
- 整体设计
  - 使用 `ScriptIntrinsicBlur/Convolve3x3/ColorMatrix` 组合流水线，参数：磨皮、美白、红润、锐化；预览 1080p，小图；保存原图。
- 开发遇到的困难
  - RS 在新 SDK 废弃；不同机型出现黑屏或性能波动；参数矩阵易错。
- 解决思路
  - 启用 RS 支持模式；双位图策略与缓存 `Allocation`；矩阵构造转置校正；按需逐步替换为 GPUImage/自研算子。
- 关键代码路径
  - `app/src/main/java/com/example/xingtuclone/utils/BeautyProcessor.kt:27-33`（流水线入口）
  - `app/src/main/java/com/example/xingtuclone/utils/BeautyProcessor.kt:75-91`（锐化 3x3 卷积）
  - `app/src/main/java/com/example/xingtuclone/utils/BeautyProcessor.kt:97-147`（美白+红润色彩矩阵）
  - `app/src/main/java/com/example/xingtuclone/ui/EditorShell.kt:216-221`（调用美颜处理）

## 滤镜与调节（ColorMatrix + GPUImage）
- 通俗说明
  - 现成的暖色/冷色/黑白/复古等滤镜，还有亮度/对比度/饱和度滑条。
  - 颜色矩阵已封装好，保证效果稳定；预览走轻量路径不拖慢。
- 整体设计
  - 基础色彩滤镜（暖色、冷色、黑白、复古等）与调节（亮度/对比度/饱和度），实时预览与强度控制；后续扩展 LUT。
- 开发遇到的困难
  - 组合矩阵的色彩校正与性能；与 RS/GPUImage 交互切换一致性。
- 解决思路
  - 常用矩阵封装（行列顺序正确）；预览选择轻量路径；GPUImage 预置滤镜列表与 UI 数据绑定。
- 关键代码路径
  - `app/src/main/java/com/example/xingtuclone/ui/EditorShell.kt:210-221`（预览生成与分类处理）
  - `app/src/main/java/com/example/xingtuclone/ui/FilterUtils.kt:31-50`（滤镜与调节项数据）

## 拼图（模板/拖拽/保存）
- 通俗说明
  - 2–6 张拼图，14种模板；长按能拖拽换位置；圆角/边距/比例可调；一键保存。
  - 多大图易爆内存，已限制加载尺寸并支持“内存不够自动降一半尺寸再保存”。
- 整体设计
  - 2–6 张共 14 种模板，长按拖拽交换；圆角/边距/比例调节；容器截图保存到相册。
- 开发遇到的困难
  - 多图原始分辨率导致 OOM；硬件位图无法截图；拖拽交换同步 UI。
- 解决思路
  - 预览限制尺寸并 `allowHardware(false)`；保存时 OOM 降尺度重试；拖拽索引回调更新状态。
- 关键代码路径
  - `app/src/main/java/com/example/xingtuclone/ui/CollageScreen.kt:309-314`（禁用硬件位图与限制尺寸）
  - `app/src/main/java/com/example/xingtuclone/ui/CollageScreen.kt:480-509`（保存 OOM 降尺度）
  - `app/src/main/java/com/example/xingtuclone/ui/CollageScreen.kt:171-189`（拖拽交换回调）

## 批量修图（队列与进度）
- 通俗说明
  - 多选图片后选模式（自动美颜/柔和滤镜），后台批量处理，列表显示进度。
  - 结果统一保存，遇到慢的操作也不阻塞界面。
- 整体设计
  - 多选图片队列，选择模式（自动美颜/柔和滤镜），IO 线程批处理，进度条与单项状态展示，保存到相册。
- 开发遇到的困难
  - 批处理中的内存与线程调度；结果收集与 UI 同步。
- 解决思路
  - 预览降采样；处理在 IO；保存返回 `Uri` 收集列表；主线程更新进度与提示。
- 关键代码路径
  - `app/src/main/java/com/example/xingtuclone/ui/BatchEditScreen.kt:55-66`（处理单张）
  - `app/src/main/java/com/example/xingtuclone/ui/BatchEditScreen.kt:83-101`（批处理与进度）
  - `app/src/main/java/com/example/xingtuclone/ui/BatchEditScreen.kt:108-122`（UI 进度与状态）

## 相册（缩略图与性能打点）
- 通俗说明
  - 支持单选/多选与最多选择数；缩略图用更快的加载方式。
  - 会统计“首图出现时间”和加载耗时，帮助我们知道哪里慢。
- 整体设计
  - 自定义相册页，单选/多选与最大数控制；Coil 缩略图加载与 TTFR/p90 打点；完成后返回 `Uri` 列表。
- 开发遇到的困难
  - 大量图片时首屏慢与滚动抖动；权限适配差异（Android 13+）。
- 解决思路
  - 指定缩略图尺寸与策略；允许硬件位图；进入与首图加载打点；权限按版本差异请求。
- 关键代码路径
  - `app/src/main/java/com/example/xingtuclone/ui/GalleryScreen.kt:148-166`（Coil 请求与打点）
  - `app/src/main/java/com/example/xingtuclone/utils/PerfLogger.kt:46-60`（报告写入）
  - `app/src/main/java/com/example/xingtuclone/ui/GalleryScreen.kt:62-83`（权限逻辑）

## 编辑器壳层（醒图风格）
- 通俗说明
  - 顶部是返回/导出，底部是分类和工具；画布支持缩放/平移浏览大图，长按可对比原图。
  - 算法在后台线程跑，界面主线程只负责显示，既稳又流畅。
- 整体设计
  - 顶部栏/画布/底部分类与工具面板的容器；对比模式、统一导出入口；预览双位图策略。
- 开发遇到的困难
  - 需要在性能与可扩展之间平衡；防止黑屏与主线程阻塞。
- 解决思路
  - 计算在 IO；主线程展示；滑条与矩阵组合轻量化；统一壳层拆分 Composable。
- 关键代码路径
  - `app/src/main/java/com/example/xingtuclone/ui/EditorShell.kt:130-145`（预览加载与双位图）
  - `app/src/main/java/com/example/xingtuclone/ui/EditorShell.kt:210-221`（预览生成与分类处理）

## 保存与结果页（MediaStore + 最近作品）
- 通俗说明
  - 一键保存到系统相册（Android 10+有“写入中”状态），保存后看结果页，能回首页或继续修图。
  - 最近作品会显示在结果页，方便快速回看。
- 整体设计
  - 统一保存到相册（MediaStore），返回 `Uri`；结果页展示保存图与最近作品，支持返回首页或继续修图。
- 开发遇到的困难
  - MediaStore 写入流程与 PENDING 标记；`Uri` 在页面间传递与路由一致性。
- 解决思路
  - Android 10+ 使用 PENDING → 清除；统一路由状态与回传；结果页双向返回入口。
- 关键代码路径
  - `app/src/main/java/com/example/xingtuclone/ui/SaveUtils.kt:19-76`（保存到相册）
  - `app/src/main/java/com/example/xingtuclone/ui/SaveUtils.kt:78-112`（保存并返回 Uri）
  - `app/src/main/java/com/example/xingtuclone/ui/SaveResultScreen.kt:65-93`（结果页展示与返回）
  - `app/src/main/java/com/example/xingtuclone/ui/HomeScreen.kt:124-163`（统一路由）

## 构建自动化与兼容
- 通俗说明
  - 已帮你打好包（APK/AAB），还接了小插件：构建前清缓存、构建后写依赖树。
  - 版本统一好（AGP/Kotlin/Compose），依赖源也做了镜像，构建更稳。
- 整体设计
  - 自定义插件清缓存与写依赖树；AGP/Kotlin/Compose 版本统一；多 Dex 与原生库打包兼容；镜像与 JitPack 仓库接入。
- 开发遇到的困难
  - 低内存 OOM、依赖解析不稳、方法数超限、RS 废弃。
- 解决思路
  - 插件挂接 `preBuild`/`assembleRelease`；关闭 release lint 与混淆；启用 `multidex` 与 `useLegacyPackaging`；仓库镜像；统一版本。
- 关键代码路径
  - `buildSrc/src/main/kotlin/AutoBuildPlugin.kt:70-105`（任务与挂接）
  - `app/build.gradle.kts:22-27`（`multiDexEnabled` 与 RS 支持）
  - `app/build.gradle.kts:47-57`（Compose 编译器与打包兼容）
  - `build.gradle.kts:1-5`（AGP/Kotlin 版本）
  - `settings.gradle.kts:1-20`（仓库与镜像）
