# 相册加载速度优化报告

## 1. 通俗说明
**为什么要优化？**
当相册里有几千张照片时，如果每次滑动都去读取原图并缩放，手机会非常卡（因为处理大图很慢也很费内存）。
**我们做了什么？**
我们引入了一个叫 `Coil` 的专业图片加载库，就像请了一个“管家”：
- **只读小图**：管家知道你在看缩略图，所以只读取 256 像素大小的小图，而不是 4000 像素的原图。
- **硬件加速**：利用手机的 GPU（显卡）来帮助显示图片，减轻 CPU 负担。
- **智能缓存**：看过的图片管家会记在内存或硬盘里，下次划回来直接显示，不用重新读。
- **后台干活**：读取和处理图片都在后台悄悄进行，不会卡住你的界面滑动。

## 2. 优化目标
- **流畅度**：大图数量（≥1000）时进入相册秒开；快速滚动时不掉帧。
- **速度**：首屏缩略图尽快展示（TTFR 指标）。
- **内存**：避免因加载大图导致的 OOM（内存溢出）崩溃。

## 3. 核心技术点
- **Coil 异步加载**：替换手写的 `BitmapFactory.decodeStream`，自动管理线程池。
- **按需解码**：明确请求缩略图尺寸（`size(256)`）与 `Scale.FILL`，配合 `Precision.INEXACT`，大幅降低解码内存占用。
- **硬件位图**：开启 `allowHardware(true)`，使用 `Bitmap.Config.HARDWARE`，减少 Java 堆内存压力。
- **性能打点**：统计进入相册到首图可见的时间（TTFR）及前 100 张图的加载耗时。

## 4. 实施细节与关键代码
### 4.1 图片加载配置 (`ui/GalleryScreen.kt`)
我们对 Coil 的 `ImageRequest` 进行了精细化配置：

```kotlin
ImageRequest.Builder(context)
    .data(item.uri)
    .crossfade(true)              // 淡入效果，体验更好
    .allowHardware(true)          // 开启硬件位图，节省内存
    .precision(Precision.INEXACT) // 允许加载尺寸不完全匹配，提升复用率
    .scale(Scale.FILL)            // 填满控件
    .size(256)                    // 限制解码尺寸为 256px，关键！
    .diskCachePolicy(CachePolicy.ENABLED) // 开启磁盘缓存
    .memoryCachePolicy(CachePolicy.ENABLED) // 开启内存缓存
    .listener(
        onStart = { PerfLogger.onItemStart(item.uri.toString()) },
        onSuccess = { _, _ -> PerfLogger.onItemSuccess(item.uri.toString(), context) }
    )
    .build()
```

### 4.2 性能打点工具 (`utils/PerfLogger.kt`)
- **TTFR (Time To First Render)**: 记录 `startEnter()` 到第一张图片 `onSuccess` 的时间差。
- **P90 Load Time**: 统计前 100 张图片加载耗时，取第 90% 位的数值（代表绝大多数图片的加载性能）。

## 5. 性能验证方法
1.  **准备环境**：连接手机，确保相册内有足够图片（建议 > 100 张）。
2.  **操作步骤**：
    - 打开应用，点击“进入相册”。
    - 快速滚动浏览，直到加载超过 100 张缩略图。
3.  **查看报告**：
    - **方式一（Logcat）**：过滤 Tag `AlbumPerf`，查找 `TTFR(ms)=...` 和 `summary={...}`。
    - **方式二（文件）**：报告会写入 `/data/data/com.example.xingtuclone/cache/album_perf_report.json`。

**日志示例：**
```text
D/AlbumPerf: enter album screen
D/AlbumPerf: TTFR(ms)=120
...
D/AlbumPerf: summary={"ttfr_ms":120,"avg_load_ms":15,"p90_load_ms":22,"samples":100}
D/AlbumPerf: written .../cache/album_perf_report.json
```

## 6. 优化前后对比（预期）

| 指标 | 优化前（手动解码原图） | 优化后（Coil 缩略图） | 提升幅度 |
| ---- | ------------------ | --------------------- | -------- |
| **TTFR (首图耗时)** | > 800ms | **< 200ms** | 提升 4x+ |
| **Avg Load (平均耗时)** | > 100ms | **< 20ms** | 提升 5x+ |
| **P90 Load (90%耗时)** | > 150ms | **< 30ms** | 提升 5x+ |
| **滚动流畅度** | 明显卡顿 | **丝般顺滑** | 质变 |

## 7. 后续可选优化
- **Paging 3 分页**：如果图片数量达到万级，需分页查询 MediaStore，避免一次性遍历 Cursor 耗时过长。
- **预加载**：结合 `LazyGridState` 监听滚动位置，提前预取下一屏的图片。
- **系统缩略图 API**：在 Android 10 (Q) 以上，尝试优先调用 `loadThumbnail` API 获取系统生成的缩略图。
