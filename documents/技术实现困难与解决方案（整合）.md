# 技术实现困难与解决方案（整合）

## 总览
- 架构：`HomeScreen` 统一路由，`EditorShell` 承载编辑壳层；保存统一走 `SaveUtils` 并进入 `SaveResultScreen`。
- 兼容：AGP/Kotlin/Compose 版本统一；多 Dex、镜像源与原生库打包兼容；权限与 `FileProvider` 路径一致。

## 裁剪旋转单页直达（uCrop）
- 困难
  - 体验嵌套：编辑器内层“调整→自由裁剪”路径深、返回复杂。
  - 机型兼容：小米等机型在编辑器内嵌裁剪时易崩溃或权限受限。
- 解决方案
  - 单页直达：新增 `CropRotateScreen`，进入即拉起 uCrop，裁剪完成直接回传，统一返回编辑流。
    - 主题与比例预设：`app/src/main/java/com/example/xingtuclone/ui/CropRotateScreen.kt:61`
    - 回调返回结果：`app/src/main/java/com/example/xingtuclone/ui/CropRotateScreen.kt:84`
  - 路由改造：`HomeScreen` 入口直达裁剪页，裁剪完成回到编辑并切换滤镜。
    - 进入裁剪并回传：`app/src/main/java/com/example/xingtuclone/ui/HomeScreen.kt:154`
    - 裁剪后切换到滤镜：`app/src/main/java/com/example/xingtuclone/ui/EditorShell.kt:193`
  - 权限与文件：目标 `dst` 使用 `FileProvider + externalCacheDir`，添加 READ/WRITE flags。
    - `FileProvider` 使用：`app/src/main/java/com/example/xingtuclone/MainActivity.kt:44`

## 构建自动化插件（依赖树 + 产物交付）
- 困难
  - 构建产物与依赖记录缺乏自动化；手动清理缓存与记录依赖成本高。
  - 低内存环境下容易 OOM，构建不稳定。
- 解决方案
  - 自定义插件 `com.example.autobuild` 挂接到构建流程，编译前清缓存、结束后写依赖树。
    - 插件挂接与任务：`buildSrc/src/main/kotlin/AutoBuildPlugin.kt:70`
  - `app` 模块应用插件并配置扩展输出路径。
    - 插件扩展配置：`app/build.gradle.kts:65`
  - 低内存优化：禁用守护进程/降低并发、关闭 release lint/混淆、启用 `multidex` 与 `useLegacyPackaging`。
    - 多 Dex：`app/build.gradle.kts:22`
    - 原生库打包：`app/build.gradle.kts:54`

## 相册加载性能（TTFR 与 p90）
- 困难
  - 图片数量大时首屏缩略图慢、滚动抖动，TTFR高。
- 解决方案
  - 统一使用 `Coil AsyncImage` 加载缩略图，指定目标尺寸与策略，采集性能数据。
    - 请求与打点：`app/src/main/java/com/example/xingtuclone/ui/GalleryScreen.kt:148`
    - 性能采集工具：`app/src/main/java/com/example/xingtuclone/utils/PerfLogger.kt:18`
  - 报告输出到缓存并在 Logcat 打印摘要。
    - 报告写入：`app/src/main/java/com/example/xingtuclone/utils/PerfLogger.kt:46`

## 编辑器 UI 重构（醒图风格）
- 困难
  - 需要统一顶部栏/底部分类与工具面板，同时保持实时预览与稳定性（避免黑屏）。
- 解决方案
  - `EditorShell` 承载壳层，分类切换与控制面板分离；预览双位图策略，计算在 IO 线程。
    - 预览加载与双位图：`app/src/main/java/com/example/xingtuclone/ui/EditorShell.kt:130`
    - 人像美颜流水线（RS）：`app/src/main/java/com/example/xingtuclone/utils/BeautyProcessor.kt:27`
  - 调色/滤镜矩阵与 GPUImage 预置组合，保持帧率与效果。
    - 调色应用：`app/src/main/java/com/example/xingtuclone/ui/EditorShell.kt:210`
    - GPUImage 滤镜数据：`app/src/main/java/com/example/xingtuclone/ui/FilterUtils.kt:31`

## 拼图保存与 OOM 保护
- 困难
  - 多图大分辨率场景，`View` 渲染转 Bitmap 时易 OOM，保存闪退。
- 解决方案
  - 降采样加载 + 禁用硬件位图以支持截图；保存时 OOM 捕获后自动降尺度重试。
    - 禁用硬件位图与限制尺寸：`app/src/main/java/com/example/xingtuclone/ui/CollageScreen.kt:309`
    - OOM 降尺度保存：`app/src/main/java/com/example/xingtuclone/ui/CollageScreen.kt:480`

## 保存与结果页跳转（分享结果）
- 困难
  - 导出后路由一致性与状态恢复；`Uri` 传递需要可靠链路。
- 解决方案
  - 统一保存到相册并返回 `Uri`，进入结果页展示最近作品与快捷返回。
    - 保存工具：`app/src/main/java/com/example/xingtuclone/ui/SaveUtils.kt:19`
    - 结果页展示：`app/src/main/java/com/example/xingtuclone/ui/SaveResultScreen.kt:65`
  - `HomeScreen` 统一路由控制与状态清理。
    - 统一路由：`app/src/main/java/com/example/xingtuclone/ui/HomeScreen.kt:124`

## 依赖与版本兼容
- 困难
  - Compose/AGP/Kotlin 版本不一致导致编译问题；国内源不稳定；原生库体积大、方法数超限；RenderScript 废弃影响旧路径。
- 解决方案
  - 版本统一：AGP `8.1.1` + Kotlin `1.9.0` + Compose Compiler `1.5.1`。
    - 版本声明：`build.gradle.kts:1`
    - Compose 编译器扩展：`app/build.gradle.kts:47`
  - 镜像与仓库：阿里云公共库与 JitPack 接入，保障依赖解析。
    - 仓库配置：`settings.gradle.kts:1`
  - 多 Dex 与打包兼容：启用 `multidex` 与 `useLegacyPackaging`，避免原生库打包异常并控制方法数。
    - `multidex`：`app/build.gradle.kts:22`
    - 打包兼容：`app/build.gradle.kts:54`
  - RenderScript 支持模式开启，并在关键路径以 GPUImage/自研矩阵替代。
    - RS 支持：`app/build.gradle.kts:24`

## 总结
- 将复杂体验拆分为“单页直达”的清晰链路（裁剪），同时以插件与性能打点提升交付与可观测性。
- 在易 OOM/机型兼容的环节加入降采样与降尺度保存策略，保障稳定；统一保存与路由方案提升连贯性。
- 通过版本与仓库策略确保构建可靠，兼顾原生库体积与方法数约束。
