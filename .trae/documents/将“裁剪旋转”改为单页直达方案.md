# 目标

* 将现有“调整→自由裁剪/旋转”嵌套体验改为单页直达：用户点击入口后直接进入一个裁剪+旋转界面，无需再在编辑器内层页选择或嵌套。

* 使用 uCrop 作为唯一的裁剪+旋转界面，保证稳定与性能，在返回后自动保存或提供简洁的导出动作。

# 技术方案

## A. 新增单页组件

* 新建 `CropRotateScreen.kt`（Compose）：

  * 入参：`srcUri: Uri`、`onBack: () -> Unit`、`onDone: (Uri) -> Unit`

  * 生命周期：`LaunchedEffect` 中立即构造并启动 uCrop（`UCropActivity`），配置主题/旋转/自由裁剪；

  * 回调处理：在 ActivityResult 中取 `UCrop.getOutput(data)`，收到裁剪结果后：

    * 方案1：直接保存到相册（返回保存后的 `Uri`），并调用 `onDone`

    * 方案2：返回裁剪结果 `Uri`，在上层统一执行导出

  * UI：仅保留顶部返回与状态指示（无多余按钮，保证“一个界面”的感受）。

## B. 路由改造（直达）

* 在所有需要“裁剪旋转”的入口处，改为直接跳转 `CropRotateScreen`：

  * 首页“调整/裁剪旋转”入口

  * 编辑器内如仍保留“裁剪”按钮，改为导航到 `CropRotateScreen`，不再内嵌在 `EditorShell`。

* 移除或隐藏 `EditorShell` 下的自研裁剪相关 UI 与手势，保留其它功能（人像、滤镜、特效）独立存在。

## C. uCrop 配置统一

* 使用 `UCrop.Options`：

  * `setToolbarColor(黑)`、`setStatusBarColor(黑)`、`setActiveControlsWidgetColor(黄绿)`（与现有主色一致）

  * `setFreeStyleCropEnabled(true)`、`setHideBottomControls(false)`、开启旋转控件（uCrop默认支持）

* 源 `srcUri` 来自 MediaStore（`content://`），目标 `dstUri` 使用 `FileProvider + externalCacheDir`，并添加 `READ/WRITE` intent flags。

* Manifest 已声明：`com.yalantis.ucrop.UCropActivity` 与 `FileProvider`。

## D. 导出策略

* 方案1（更简洁）：在 `CropRotateScreen` 的 uCrop 回调中直接调用保存工具 `saveBitmapToGalleryReturnUri(...)`，保存成功后 `onDone(uri)` 并返回上一页；不再显示单独的“导出”按钮。

* 方案2（可选）：保留一个右下角悬浮“导出”按钮，仅在需要用户确认时显示；默认自动保存。

## E. 代码改动点

* 新增：`app/src/main/java/com/example/xingtuclone/ui/CropRotateScreen.kt`

* 路由：`HomeScreen.kt` 调整入口改为导航到 `CropRotateScreen`；如在 `EditorShell.kt` 仍有“裁剪”按钮，则改为导航而非内嵌。

* 清理：移除 `EditorShell.kt` 自研裁剪相关状态（`freeCropRect/freeCropTempRect/cropAspect`）与覆盖层绘制/手势代码，以及“应用裁剪/清除裁剪框”等按钮。

* 保留：`EditorShell.kt` 的人像、滤镜、特效等现有功能；顶部“导出”逻辑不变。

# 验收标准

* 任一“裁剪旋转”入口点击后，直接打开 uCrop 单页界面（黑色工具栏、黄绿控件），支持自由裁剪与旋转；完成后返回应用并看到裁剪结果。

* 不再出现嵌套的“调整→自由裁剪”内页或自研矩形框；整体体验为“一个界面”。

* 小米14设备点击“裁剪”不再闪退；若异常，`app_error.log` 有完整错误记录。

# 风险与兼容

* 部分机型权限策略不同：已用 `FileProvider + externalCacheDir` 与 `READ/WRITE` flags，通常可行；如仍报错则回退到 `externalFilesDir(Pictures)` 并共享持久权限。

* 体感变化：从“编辑器内嵌裁剪”改为“单页直达”，需要入口文案与导航一致；我会保持入口名称为“裁剪旋转”。

# 确认后实施步骤

1. 新建 `CropRotateScreen.kt` 并接入 uCrop（含回调保存）。
2. 更新 `HomeScreen.kt` 与任何仍调用 `EditorShell` 裁剪的地方，改为导航到 `CropRotateScreen`。
3. 清理 `EditorShell.kt` 裁剪相关状态与 UI；保留其它功能与导出逻辑。
4. 设备验证（含小米14）：点击裁剪 → uCrop → 完成 → 返回展示并可导出；异常日志可在 `cache/app_error.log` 查看。

请确认以上方案，我将开始实施。
