# 相册加载速度优化报告

## 优化目标
- 大图数量（≥1000）时进入相册流畅；首屏尽快展示缩略图；滚动不卡顿。

## 优化思路
- 使用 `Coil` 的 `AsyncImage` 替换手写 `BitmapFactory.decodeStream`，利用异步解码、线程池与内存/磁盘缓存。
- 明确请求缩略图尺寸（约 256px）与 `Scale.FILL/Precision.INEXACT`，避免加载原图导致的大内存与慢解码。
- 允许硬件位图（allowHardware=true）用于缩略图，减少 GC 压力。
- 在进入相册与前 100 张图片加载过程中打点：首图可见（TTFR）、平均/90 分位加载时长，并写入缓存目录 `album_perf_report.json`。

## 实施位置
- `ui/GalleryScreen.kt`：缩略图改为 `AsyncImage`，添加监听与打点。
- `utils/PerfLogger.kt`：新增性能日志工具，统计并输出报告。

## 数据采集方法
- 设备连接后，打开相册页面，滚动一屏以上；应用会在加载第 100 张缩略图后写入报告。
- 报告路径：`/data/data/com.example.xingtuclone/cache/album_perf_report.json`
- 同时在 Logcat 以 tag=`AlbumPerf` 打印：`TTFR(ms)=...` 与 `summary=...`

## 指标定义
- TTFR：进入相册到首张缩略图显示的毫秒数。
- avg_load_ms：前 100 张缩略图的平均加载耗时。
- p90_load_ms：前 100 张缩略图加载耗时的 90 分位。

## 优化前后对比（示例结构）
- 设备/系统：<型号/Android 版本>
- 图片数量：<总数>
- 首屏网格尺寸：Adaptive(≥120dp)，缩略图目标尺寸：≈256px

| 指标 | 优化前（手动解码） | 优化后（Coil 缩略图） |
| ---- | ------------------ | --------------------- |
| TTFR(ms) | <填数据> | <填数据> |
| avg_load_ms | <填数据> | <填数据> |
| p90_load_ms | <填数据> | <填数据> |
| 峰值内存(MB) | <可选> | <可选> |

> 说明：以上数据由 `album_perf_report.json` 与 Logcat 打点生成；峰值内存可通过 Android Studio Profiler 获取。

## 预期收益
- TTFR显著下降（通常可降低至数百毫秒量级，设备相关）。
- 平均/90分位加载时长降低，滚动更顺畅，卡顿帧减少。
- 缓存生效后再次进入相册更快（内存/磁盘命中）。

## 后续可选优化
- Paging 3 分页查询 MediaStore，降低一次性游标遍历成本（大于万张时）。
- 使用系统 `loadThumbnail`（API 29+）作为特定机型的加速路径。
- 结合 `LazyGridState` 预取下一屏缩略图以进一步减少滚动抖动。

